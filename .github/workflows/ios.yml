name: iOS Build & Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Set up Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.4.app

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: DerivedData
          key: ${{ runner.os }}-DerivedData-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-DerivedData-

      - name: Install dependencies
        run: |
          xcodebuild -resolvePackageDependencies -scheme MediStock

      - name: Create fake GoogleService-Info.plist
        run: |
          mkdir -p MediStock/Configurations
          echo '<?xml version="1.0" encoding="UTF-8"?>' > MediStock/Configurations/GoogleService-Info.plist
          echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> MediStock/Configurations/GoogleService-Info.plist
          echo '<plist version="1.0"><dict></dict></plist>' >> MediStock/Configurations/GoogleService-Info.plist

      - name: Build and Test
        run: |
          xcodebuild clean build test \
            -scheme MediStock \
            -destination "platform=iOS Simulator,name=iPhone 15,OS=17.5" \
            -skip-testing:"MediStockUITests" \
            -derivedDataPath DerivedData \
            CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO
